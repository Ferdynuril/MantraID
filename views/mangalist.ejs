<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manga Home</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-900 text-gray-100">
    <!-- Navbar -->

  <%- include("partial/navbar") %>
  <div class="max-w-7xl mx-auto p-4">
    
    <div class="justify-between items-center flex border-b-4 border-blue-300 mb-2">
      <h1 class="text-3xl font-bold mb-2">List Manga <span class=" text-xl bg-blue-600 px-3 py-1 rounded-xl"><%= totalMangas %></span></h1>
      <button id="filterBtn" class="bg-blue-600 text-white px-4 py-2 rounded mb-2">Filter</button>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="fixed inset-0 z-50 hidden items-center justify-center">
      <!-- overlay -->
      <div id="filterOverlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

      <!-- modal panel -->
      <div class="relative z-10 max-w-2xl w-full mx-4">
      <form id="filterForm" method="GET" action="" class="bg-gray-800 text-gray-100 rounded-lg overflow-hidden shadow-lg">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
      <h2 class="text-lg font-semibold">Filter Manga</h2>
      <button type="button" id="closeFilter" aria-label="Close" class="text-gray-300 hover:text-white">âœ•</button>
      </div>

      <div class="p-4 space-y-4">
      <!-- Genres -->
      <div>
        <label class="block mb-2 font-medium">Genre</label>
        <div class="flex flex-wrap gap-2">
        <% TotalGenre.forEach(function(g, i){ %>
          <div>
          <input id="genre-<%= i %>" type="checkbox" data-group="Genre" value="<%= g.name %>" class="peer sr-only">
          <label for="genre-<%= i %>" class="inline-flex items-center justify-center px-3 py-1 rounded-md border border-gray-700 cursor-pointer text-sm transition-colors bg-gray-700 hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-transparent">
            <span class="truncate"><%= g.name %> <span class="text-blue-300">(<%= g.total %>)</span></span>
          </label>
          </div>
        <% }) %>
        </div>
      </div>

      <!-- Themes -->
      <div>
        <label class="block mb-2 font-medium">Theme</label>
        <div class="flex flex-wrap gap-2">
        <% TotalTheme.forEach(function(t, j){ %>
          <div>
          <input id="theme-<%= j %>" type="checkbox" data-group="Theme" value="<%= t.name %>" class="peer sr-only">
          <label for="theme-<%= j %>" class="inline-flex items-center justify-center px-3 py-1 rounded-md border border-gray-700 cursor-pointer text-sm transition-colors bg-gray-700 hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-transparent">
            <span class="truncate"><%= t.name %> <span class="text-blue-300">(<%= t.total %>)</span></span>
          </label>
          </div>
        <% }) %>
        </div>
      </div>

      <!-- Status -->
      <div>
        <label class="block mb-2 font-medium">Status</label>
        <div class="flex flex-wrap gap-2">
        <% TotalStatus.forEach(function(s, k){ %>
          <div>
          <input id="status-<%= k %>" type="checkbox" data-group="Status" value="<%= s.name %>" class="peer sr-only">
          <label for="status-<%= k %>" class="inline-flex items-center justify-center px-3 py-1 rounded-md border border-gray-700 cursor-pointer text-sm transition-colors bg-gray-700 hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-transparent">
            <span class="truncate"><%= s.name %> <span class="text-blue-300">(<%= s.total %>)</span></span>
          </label>
          </div>
        <% }) %>
        </div>
      </div>

      <!-- Project -->
       <div>
        <label class="block mb-2 font-medium">Project</label>
        <div class="flex gap-3">
        <div>
        <input id="project" type="checkbox" data-group="Project" value="true" class="peer sr-only">
        <label for="project" class="inline-flex items-center justify-center px-3 py-1 rounded-md border border-gray-700 cursor-pointer text-sm transition-colors bg-gray-700 hover:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-transparent">
            <span class="truncate">Project <span class="text-blue-300">(<%= mangas.filter(m => m.project).length %>)</span></span>
          </label>
        </div>
       </div>
      </div>

      <!-- hidden inputs that will contain comma-separated values -->
      <input type="hidden" name="genre" id="hiddenGenre" value="">
      <input type="hidden" name="theme" id="hiddenTheme" value="">
      <input type="hidden" name="status" id="hiddenStatus" value="">
      <input type="hidden" name="project" id="hiddenProject" value="">
      </div>

      <div class="flex items-center justify-between p-4 border-t border-gray-700">
      <div class="flex gap-2">
        <button type="button" id="clearFilters" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">Clear</button>
        <button type="button" id="closeFiltersFooter" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">Cancel</button>
      </div>
      <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white">Apply Filters</button>
      </div>
      </form>
      </div>
    </div>

    <script>
      (function () {
        const filterBtn = document.getElementById('filterBtn');
        const modal = document.getElementById('filterModal');
        const overlay = document.getElementById('filterOverlay');
        const closeBtn = document.getElementById('closeFilter');
        const closeFooter = document.getElementById('closeFiltersFooter');
        const clearBtn = document.getElementById('clearFilters');
        const form = document.getElementById('filterForm');

        if (!form) return;

        function openModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
        function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

        if (filterBtn) filterBtn.addEventListener('click', openModal);
        if (overlay) overlay.addEventListener('click', closeModal);
        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (closeFooter) closeFooter.addEventListener('click', closeModal);

        // helper to update hidden inputs from checkboxes
        function syncHidden() {
          const groups = { Genre: [], Theme: [], Status: [], Project: [] };
          form.querySelectorAll('input[type="checkbox"][data-group]').forEach(cb => {
            const g = cb.getAttribute('data-group');
            if (cb.checked && groups[g]) groups[g].push(cb.value);
          });
          const hg = document.getElementById('hiddenGenre');
          const ht = document.getElementById('hiddenTheme');
          const hs = document.getElementById('hiddenStatus');
          const hp = document.getElementById('hiddenProject');

          if (hg) hg.value = groups.Genre.join(',');
          if (ht) ht.value = groups.Theme.join(',');
          if (hs) hs.value = groups.Status.join(',');
          if (hp) hp.value = groups.Project.join(',');
        }

        // clear
        clearBtn && clearBtn.addEventListener('click', () => {
          form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          document.getElementById('hiddenGenre').value = '';
          document.getElementById('hiddenTheme').value = '';
          document.getElementById('hiddenStatus').value = '';
          document.getElementById('hiddenProject').value = '';
        });

        // keep hidden inputs in sync when user toggles checkboxes
        form.querySelectorAll('input[type="checkbox"][data-group]').forEach(cb => {
          cb.addEventListener('change', syncHidden);
        });

        // parse URL params and auto-check matching checkboxes
        function loadFromURL() {
          const params = new URLSearchParams(window.location.search);
          // support both capitalized and lowercase param names
          const groups = ['Genre', 'Theme', 'Status', 'Project'];
          groups.forEach(group => {
            // check either "Genre" or "genre" param
            let raw = params.get(group) || params.get(group.toLowerCase());
            if (!raw) return;
            // split by comma, decode and trim
            const vals = raw.split(',').map(v => decodeURIComponent(v).trim()).filter(Boolean);
            if (!vals.length) return;
            // for each value, find matching checkbox(s) and check them
            vals.forEach(val => {
              form.querySelectorAll('input[type="checkbox"][data-group="' + group + '"]').forEach(cb => {
                if (cb.value === val) cb.checked = true;
              });
            });
          });
          // update hidden inputs to reflect checked checkboxes
          syncHidden();
        }

        // ensure before submit hidden inputs are set (redundant with syncHidden but safe)
        form.addEventListener('submit', function (e) {
          syncHidden();
          // natural GET submit will include the hidden fields
        });

        // run on load
        loadFromURL();
      })();
    </script>

      <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-5">

        <% mangas.forEach(m => { %>
        <div class="bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition relative">

          <!-- COVER -->
          
          <a href="/Manga/<%= m.slug %>" class="block group overflow-hidden rounded">
            <img 
                src="<%= m.cover %>" 
                alt="<%= m.slug %> cover"
                class="w-full object-cover transition-transform duration-300 group-hover:scale-110"
            />
            </a>
            <div class="<%= m.status === 'Ongoing' ? 'bg-blue-500' : m.status === 'Completed' ? 'bg-green-500' : m.status === 'Dropped' ? 'bg-red-500' : 'bg-gray-500' %> absolute -left-[40px] top-3 w-[160px] -rotate-35  h-7 text-center flex items-center justify-center text-white rounded">
              <%= m.status %>
            </div>
          <div class="absolute top-1 right-1 w-8 h-5 overflow-hidden rounded shadow"><img alt="JP" class="w-full h-full object-cover" src="https://flagcdn.com/w320/jp.png"></div>  

          <div class="p-3">

            <!-- TITLE -->
            <a href="/Manga/<%= m.slug %>"
               class="font-semibold text-sm hover:text-blue-400 block truncate">
              <%= m.title.replace(/-/g, " ") %>
            </a>

            <!-- 3 LATEST CHAPTERS -->
            <div class="mt-2 space-y-1">
              <% m.chapters.slice(0,3).forEach(ch => { %>
              <a href="/Manga/<%= m.slug %>/<%= ch.url %>"
                 class="flex justify-between items-center text-xs bg-gray-700 hover:bg-gray-600 py-1 px-2 rounded">
                <span>Ch <%= ch.chapter %></span>
                <span class="text-[11px] text-gray-400"><%= ch.ago %></span>
              </a>
              <% }) %>
            </div>

          </div>
        </div>
        <% }) %>

      </div>
    </div>


</body>
</html>


